from framefox.core.controller.abstract_controller import AbstractController
from framefox.core.routing.decorator.route import Route
from typing import Optional, Dict
from src.repository.{{ repository_file_name }} import {{ repository_class_name }}
from src.entity.{{ entity_file_name }} import {{ entity_class_name }}
from framefox.core.orm.entity_manager import EntityManager
from fastapi import Request

class {{ controller_class_name }}(AbstractController):
    def __init__(self, entityManager: EntityManager):
        self.entity_manager = entityManager
        self.repository = {{ repository_class_name }}()

    @Route("/{{ entity_name }}s", "{{ entity_file_name }}.read_all", methods=["GET"])
    async def read_all(self):
        items = self.repository.find_all()
        return self.render("{{ entity_name }}/index.html", {"items": items})

    @Route("/{{ entity_name }}/create", "{{ entity_file_name }}.create", methods=["GET", "POST"])
    async def create(self, request: Request, {{ entity_name }}: Optional[{{ entity_class_name }}.generate_create_model()] = None):
        if request.method == "POST" and {{ entity_name }}:
            try:
                entity_instance = self.repository.model(**{{ entity_name }}.dict())
                self.entity_manager.persist(entity_instance)
                self.entity_manager.commit()
                self.flash("success", "{{ entity_class_name }} created successfully!")
                return self.redirect(self.url_for("{{ entity_file_name }}.read_all"))
            except Exception as e:
                self.flash("error", str(e))
                return self.render("{{ entity_name }}/create.html", {"error": str(e)})
        
        return self.render("{{ entity_name }}/create.html")

    @Route("/{{ entity_name }}/{id}", "{{ entity_file_name }}.read", methods=["GET"])
    async def read(self, id: int):
        item = self.repository.find({"id": id})
        if not item:
            self.flash("error", "{{ entity_class_name }} not found!")
            return self.redirect(self.url_for("{{ entity_file_name }}.read_all"))
        return self.render("{{ entity_name }}/read.html", {"item": item})

    @Route("/{{ entity_name }}/edit/{id}", "{{ entity_file_name }}.edit", methods=["GET"])
    async def edit(self, id: int):
        item = self.repository.find({"id": id})
        if not item:
            self.flash("error", "{{ entity_class_name }} not found!")
            return self.redirect(self.url_for("{{ entity_file_name }}.read_all"))
        return self.render("{{ entity_name }}/update.html", {"item": item})

    @Route("/{{ entity_name }}/{id}", "{{ entity_file_name }}.update", methods=["POST"])
    async def update(self, id: int, {{ entity_name }}: {{ entity_class_name }}.generate_create_model()):
        try:
            entity_instance = self.repository.find({"id": id})
            if not entity_instance:
                self.flash("error", "{{ entity_class_name }} not found!")
                return self.redirect(self.url_for("{{ entity_file_name }}.read_all"))
            
            for key, value in {{ entity_name }}.dict().items():
                setattr(entity_instance, key, value)
            
            self.entity_manager.persist(entity_instance)
            self.entity_manager.commit()
            self.flash("success", "{{ entity_class_name }} updated successfully!")
            return self.redirect(self.url_for("{{ entity_file_name }}.read_all"))
        except Exception as e:
            self.flash("error", str(e))
            return self.redirect(self.url_for("{{ entity_file_name }}.edit", id=id))

    @Route("/{{ entity_name }}/delete/{id}", "{{ entity_file_name }}.delete", methods=["POST"])
    async def delete(self, id: int):
        try:
            entity_instance = self.repository.find({"id": id})
            if not entity_instance:
                self.flash("error", "{{ entity_class_name }} not found!")
                return self.redirect(self.url_for("{{ entity_file_name }}.index"))
            
            self.entity_manager.delete(entity_instance)
            self.entity_manager.commit()
            self.flash("success", "{{ entity_class_name }} deleted successfully!")
            return self.redirect(self.url_for("{{ entity_file_name }}.index"))
        except Exception as e:
            self.flash("error", str(e))
            return self.redirect(self.url_for("{{ entity_file_name }}.index"))